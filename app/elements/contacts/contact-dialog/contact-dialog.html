<dom-module id="contact-dialog">
	<template>
		<style>
			:host {
				display: none;
				position: fixed;
				background: white;
				@apply(--shadow-elevation-16dp);
				width: 450px;
				height: 100%;
				left: 50%;
				top: 0;
				z-index: 55;
				margin-left: -225px;
			}
			iron-icon {
				color: var(--secondary-text-color);
				margin-right: 8px;
			}
			paper-input {
				display: inline-block;
				width: calc(100% - 36px);
			}
			#head {
				height: calc(64px - 16px);
				background: var(--default-primary-color);
				color: white;
				padding: 8px;
			}
			#topName {
				font-size: larger;
				top: 10px;
				position: relative;
			}
			#content {
				overflow-y: scroll;
				padding: 8px;
				height: calc(100% - 56px);
			}
			.addItem {
				color: var(--default-primary-color);
				margin-left: 36px;
				cursor: pointer;
			}
			@media (max-width: 450px) {
				:host {
					width: 100%;
					margin-left: -50%;
				}
			}
		</style>
		<div id="head" class="header">
			<paper-icon-button
				id="closeDialog"
				icon="clear" 
				on-tap="clearDialog" 
				style="float: left; left: -8px;">
			</paper-icon-button>
			<span id="topName">[[contact.fullname]]</span>
			<paper-button 
				on-tap="closeDialog" 
				style="float: right; position: absolute; right: 0;">
				Save
			</paper-button>
		</div>
		<div id="content">
			<iron-icon icon="social:person"></iron-icon>
			<paper-input label="Vollständiger Name" value="{{contact.fullname}}"></paper-input>
			<div id="occupationList"></div>
			<div class="addItem" on-tap="addOccupation">Tätigkeit hinzufügen</div>
			<div id="emailList"></div>
			<div id="phoneList"></div>
			<div id="addressList"></div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'contact-dialog',

			behaviors: [
				Polymer.NeonAnimationRunnerBehavior
			],

			properties: {
				contact: {
					type: Object,
					observer: '_setUp'
				},
				opened: {
					type: Boolean,
					notify: true,
					value: false,
					observer: '_updateContact'
				},
				animationConfig: {
					value: function() {
						return {
							'open': {
								name: 'scale-up-animation',
								node: this,
								axis: ''
							},
							'close': {
								name: 'fade-out-animation',
								node: this
							},
							'rotateIcon': {
								name: 'transform-animation',
								node: this.$.closeDialog,
							  	transformFrom: 'rotate(0deg)',
								transformTo: 'rotate(360deg)'
							}
						}
					}
				}
			},

			listeners: {
				'neon-animation-finish': '_onNeonAnimationFinish',
				'removeOccupation': '_onOccupationRemove',
				'email': '_onEmail',
				'phone': '_onPhone',
				'address': '_onAddress'
			},

			closeDialog: function () {
				this.opened = false;
			},

			_onNeonAnimationFinish: function() {
				if(this.opened)
					this.style.display = 'block';
				else
					this.style.display = 'none';
			},

			_updateContact: function(newVal, oldVal) {
				if(newVal) {
					this.style.display = 'block';
					this.playAnimation('open');
					this.playAnimation('rotateIcon');
					this.oFullname = this.contact.fullname;
					this.oOccupations = this.contact.occupations;
					this.oEmails = this.contact.emails;
					this.oPhones = this.contact.phones;
					this.oAddresses = this.contact.addresses;
				}
				else if(!newVal) {
					this.playAnimation('close');
				}
				if(newVal === false && oldVal === true && !this.cleared) {
					this.set('contact.occupations', this.getOccupations());
					this.set('contact.emails', this.getEmails());
					this.set('contact.phones', this.getPhones());
					this.set('contact.addresses', this.getAddresses());
					this.fire('contact', {
						contact: this.contact
					});
				}
				this.cleared = false;
			},

			clearDialog: function() {
				this.playAnimation('rotateIcon');
				this.cleared = true;
				this.opened = false;
				this.contact = {
					fullname: this.oFullname,
					occupations: this.oOccupations,
					emails: this.oEmails,
					phones: this.oPhones,
					addresses: this.oAddresses
				}
			},

			_setUp: function(newVal, oldVal) {
				if(newVal) {
					this.$.occupationList.innerHTML = '';
					this.$.emailList.innerHTML = '';
					this.$.phoneList.innerHTML = '';
					this.$.addressList.innerHTML = '';

					if(this.contact.occupations) {
						for (var i = 0; i < this.get('contact.occupations').length; i++) {
							var occupation = document.createElement('contact-occupation');
							this.$.occupationList.appendChild(occupation);
							occupation.occupation = this.get('contact.occupations.' + i + '.occupation');
							occupation.company = this.get('contact.occupations.' + i + '.company');
						}
					}

					if(this.contact.emails) {
						for (var i = 0; i < this.get('contact.emails').length; i++) {
							var email = document.createElement('contact-email');
							this.$.emailList.appendChild(email);
							email.label = this.get('contact.emails.' + i + '.label');
							email.email = this.get('contact.emails.' + i + '.value');
						}
					}
					this._onEmail();

					if(this.contact.phones) {
						for (var i = 0; i < this.get('contact.phones').length; i++) {
							var phone = document.createElement('contact-phone');
							this.$.phoneList.appendChild(phone);
							phone.label = this.get('contact.phones.' + i + '.label');
							phone.phone = this.get('contact.phones.' + i + '.value');
						}
					}
					this._onPhone();

					if(this.contact.addresses) {
						for (var i = 0; i < this.get('contact.addresses').length; i++) {
							var address = document.createElement('contact-address');
							this.$.addressList.appendChild(address);
							address.label = this.get('contact.addresses.' + i + '.label');
							address.address = this.get('contact.addresses.' + i + '.value');
						}
					}
					this._onAddress();
				}
			},

			addOccupation: function() {
				var occupation = document.createElement('contact-occupation');
				this.$.occupationList.appendChild(occupation);
				// this.notifyResize();
			},

			_onOccupationRemove: function(e) {
				e.target.remove();
				// this.notifyResize();
			},

			_onEmail: function() {
				var emails = Array.prototype.slice.call(this.querySelectorAll('contact-email'));
				for (var i = 0; i < emails.length-1; i++) {
					if(emails[i].email === '') {
						emails[i].remove();
						emails.splice(i, 1);
					}
				}
				if (emails.length === 0 || emails[emails.length-1].email !== '') {
					var email = document.createElement('contact-email');
					this.$.emailList.appendChild(email);
				}
				// this.notifyResize();
			},

			_onPhone: function() {
				var phones = Array.prototype.slice.call(this.querySelectorAll('contact-phone'));
				for (var i = 0; i < phones.length-1; i++) {
					if(phones[i].phone === '') {
						phones[i].remove();
						phones.splice(i, 1);
					}
				}
				if (phones.length === 0 || phones[phones.length-1].phone !== '') {
					var phone = document.createElement('contact-phone');
					this.$.phoneList.appendChild(phone);
				}
				// this.notifyResize();
			},

			_onAddress: function() {
				var addresses = Array.prototype.slice.call(this.querySelectorAll('contact-address'));
				for (var i = 0; i < addresses.length-1; i++) {
					if(addresses[i].address === '') {
						addresses[i].remove();
						addresses.splice(i, 1);
					}
				}
				if (addresses.length === 0 || addresses[addresses.length-1].address !== '') {
					var address = document.createElement('contact-address');
					this.$.addressList.appendChild(address);
				}
				// this.notifyResize();
			},

			getOccupations: function() {
				var occupationElements = this.querySelectorAll('contact-occupation');
				var occupations = [];
				for (var i = 0; i < occupationElements.length; i++) {
					if (occupationElements[i].occupation !== "" || occupationElements[i].company) {
						occupations.push({
							occupation: occupationElements[i].occupation,
							company: occupationElements[i].company
						});
					}
				}
				return occupations;
			},

			getEmails: function() {
				var emailElements = this.querySelectorAll('contact-email');
				var emails = [];
				for (var i = 0; i < emailElements.length; i++) {
					if (emailElements[i].email !== "") {
						emails.push({
							label: emailElements[i].label,
							value: emailElements[i].email
						});
					}
				}
				return emails;
			},

			getPhones: function() {
				var phoneElements = this.querySelectorAll('contact-phone');
				var phones = [];
				for (var i = 0; i < phoneElements.length; i++) {
					if (phoneElements[i].phone !== "") {
						phones.push({
							label: phoneElements[i].label,
							value: phoneElements[i].phone
						});
					}
				}
				return phones;
			},

			getAddresses: function() {
				var addressElements = this.querySelectorAll('contact-address');
				var addresses = [];
				for (var i = 0; i < addressElements.length; i++) {
					if (addressElements[i].address !== "") {
						addresses.push({
							label: addressElements[i].label,
							value: addressElements[i].address
						});
					}
				}
				return addresses;
			}
		});
	</script>
</dom-module>