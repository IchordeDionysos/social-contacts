<dom-module id="contact-groups">
	<template>
		<style>
			:host {
				display: block;
			}
			iron-icon {
				color: var(--secondary-text-color);
			}
			paper-input-container {
				display: inline-block;
				width: calc(100% - 28px);
				min-height: 67px;
			}
			paper-input-container.contact-group > div.input-content {
				min-height: 31px
			}
			input {
				width: 135px;
			}
			#chip {
				background: var(--paper-grey-200);
				border-radius: 16px;
				padding: 4px;
				padding-left: 8px;
				margin: 2px 2px;
				line-height: 30px;
				display: inline-block;
				height: 19px;
				vertical-align: bottom;
				color: var(--secondary-text-color);
			}
			.groupWrapper {
				position: relative;
				top: -5px;
			}
			.clearGroup {
				width: 15px;
				height: 15px;
				position: relative;
				top: -5px;
			}
			#dropdown {
				position: absolute;
				visibility: collapse;
				background: white;
				z-index: 12;
				width: calc(100% - 40px);
			}
		</style>
		<iron-icon icon="social:group"></iron-icon>
		<paper-input-container always-float-label>
			<label>Gruppen</label>
			<div class="paper-input-input">
				<template id="groups" is="dom-repeat" items={{groups}} as="group">
					<span id="chip">
						<span class="groupWrapper">[[group]]</span>
						<iron-icon class="clearGroup" icon="clear" on-tap="removeGroup"></iron-icon>
					</span>
				</template>
				<input is="iron-input" style="width: 60%" bind-value="{{searchString}}" on-focus="onFocus" on-blur="onBlur">
			</div>
			<paper-material id="dropdown" class="dropdown-content" elevation="1">
				<template id="groupList" is="dom-repeat" 
					items={{groupList}} filter="{{computeFilter(searchString, groups.*)}}"
					as="groupItem">
					<paper-item on-tap="select">[[groupItem.name]]</paper-item>					
				</template>
				<template is="dom-if" if={{notIsGroupItem(searchString)}}>
					<paper-item on-tap="addGroup"><span>[[searchString]]</span>&nbsp;hinzufügen</paper-item>
				</template>
				<template is="dom-if" if={{alreadyAdded(searchString)}}>
					<paper-item><span>Gruppe schon hinzugefügt</paper-item>
				</template>
			</paper-material>
		</paper-input-container>
	</template>
	<script>
		Polymer({
			is: 'contact-groups',

			properties: {
				groups: {
					type: Array,
					value: function () {
						return ['Firstline', 'Familie'];
					}
				},
				groupList: {
					type: Array,
					value: function () {
						return [{name:'Firstline'}, {name:'Gruppe1'}, {name:'Gruppe2'}, {name:'Gruppe3'}, {name:'Familie'}];
					}
				},
				searchString: {
					type: String
				}
			},

			addGroup: function() {
				this.fire('groupAdded', {
					group: this.searchString
				});
				this.push('groups', this.searchString);
				this.push('groupList', {
					name: this.searchString
				});
				this.searchString = '';
			},

			select: function(e) {
				var item = this.$.groupList.itemForElement(e.target);
				this.push('groups', item.name);
				this.searchString = '';
				that.$.dropdown.style.visibility = 'hidden';
			},

			computeFilter: function(string) {
				if(string == undefined)
					return null;
				else {
					string = string.toLowerCase();
					var that = this;
					return function(groupItem) {
						var group = groupItem.name.toLowerCase();
						for(var i=0; i<string.length; i++) {
							if(string.charAt(i) !== group.charAt(i) || that.isSelected(groupItem))
								return false;
						}
						if(string.length === 0 && that.isSelected(groupItem))
							return false;
						return true;
					};
				}
			},

			isSelected: function(item) {
				for(var i=0; i<this.groups.length; i++) {
					if(this.groups[i] === item.name)
						return true;
				}
				return false;
			},

			notIsGroupItem: function(string) {
				if(!string)
					return false;
				else {
					for(var i=0; i<this.groupList.length; i++) {
						if(string === this.groupList[i].name)
							return false;
					}
				}
				return true;
			},

			alreadyAdded: function(string) {
				for(var i=0; i<this.groups.length; i++) {
					if(this.groups[i] === string)
						return true;
				}
				return false;
			},

			onFocus: function() {
				this.$.dropdown.style.visibility = 'visible';
			},

			onBlur: function() {
				var that = this;
				window.setTimeout(function() {
					that.$.dropdown.style.visibility = 'hidden';
				}, 250);
			},

			removeGroup: function(e) {
				var item = this.$.groups.itemForElement(e.target);
				var index = this.getIndex(item);

				if(index || index === 0)
					this.splice('groups', index, 1);
			},

			getIndex: function(item) {
				for(var i=0; i<this.groups.length; i++) {
					if(this.groups[i] === item)
						return i;
				}
			}
		});
	</script>
</dom-module>