<dom-module id="app-data">
  <style>
    paper-dialog {
      padding: 32px;
    }
    .google-sign-in {
      display: inline-block;
      background: #4285f4;
      color: white;
      width: 190px;
      border-radius: 5px;
      white-space: nowrap;
    }
    .google-sign-in:hover {
      cursor: pointer;
    }
    .google-sign-in-icon {
      background: url('/images/google-sign-in/g-normal.png') transparent 5px 50% no-repeat;
      display: inline-block;
      vertical-align: middle;
      width: 42px;
      height: 42px;
      border-right: #2265d4 1px solid;
    }
    .google-sign-in-label {
      display: inline-block;
      vertical-align: middle;
      padding-left: 42px;
      padding-right: 42px;
      font-size: 14px;
      font-weight: bold;
      /* Use the Roboto font that is loaded in the <head> */
      font-family: 'Roboto', sans-serif;
    }
  </style>
  <template>
    <firebase-auth id="auth" 
                   user="{{user}}"
                   location="{{location}}"
                   provider="google">
    </firebase-auth>
    
    <firebase-collection location="{{userLocation}}"
                         ref="{{ref}}"
                         data="{{fbData}}"
                         on-firebase-value="_firebaseLoaded">
    </firebase-collection>
    <!--
    <iron-localstorage name="social-contacts"
                       on-iron-localstorage-load="_backupLoaded"
                       value="{{backupData}}">
    </iron-localstorage>
    -->
    <paper-dialog modal
                  opened="{{!user}}"
                  entry-animation="scale-up-animation"
                  exit-animation="fade-out-animation">
      <h2>Oh hai! Please sign in</h2>
      <div>
        <div class="google-sign-in"
             tabindex="0"
             on-tap="signIn">
          <span class="google-sign-in-icon"></span>
          <span class="google-sign-in-label">Google</span>
        </div>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'app-data',
      
      properties: {
        data: {
          notify: true
        },
        user: {
          observer: '_userChanged'
        },
        _firebaseConneted: {
          value: false
        },
        directory: {
          type: String
        }
      },
      
      signIn: function() {
        this.$.auth.login();
      },
      
      signOut: function() {
        this.ref.unauth();
        this.user = null;
      },
      
      _userChanged: function(user) {
        if(user) {
          this.userLocation = [this.location, this.directory, this.user.uid].join('/');
        }
      },
      
      _firebaseLoaded: function() {
        this._firebaseConnected = true;
        this.data = this.fbData;
        this.backupData = this.fbData;
        this.linkPaths('fbData', 'data');
        this.linkPaths('backupData', 'data');
      },
      
      _backupLoaded: function() {
        if(!this._firebaseConnected) {
          this.data = this.backupData.slice();
        }
      }
      
    });
  </script>
</dom-module>